#
# XenServer patch queue on top of xen-4.3-testing.hg
#    Upstream at http://http://xenbits.xen.org/hg/xen-4.3-testing.hg/
#
# In an effort to reduce future work of upgrading Xen versions, all patches in
# this queue require a justification as to why they can't/won't be upstreamed,
# with the implication that everything else should be upstreamed.
#
# If in any doubt, the ring0 patch queue maintainer will be happy to help.
#
# All patches should follow the guidelines listed here:
#       http://wiki.xen.org/wiki/Submitting_Xen_Patches
# in particular with respect to a description and S-o-b lines, with the
# exception of temporary debugging patches, which should contain at least a CA
# reference.
#
# Overview of sections:
# * XenServer build system integration.
#       **Minimal Upstream makefile hacks**
# * Upstream patches.
#       Verbatim patches from upstream, possibly with tweaks because of backporting
#       Typically from xen-{4.3,unstable}.hg
# * Patches which are upstream but hard to backport.
#       Only if upstream has diverged enough.  Hopefully empty
# * Patches for upstream.
#       Most patches should be in this section, especially new ones.  By using
#       this section, you are assuming responsibility for getting the patches
#       included upstream, and will be periodically chased by the patch queue
#       maintainer.
# * Un-upstreamable patches.
#       CC-mode restrictions etc.  Should be minimal.
# * Technical debt.
#       Legacy patches brought forward from the past.  This section should
#       never increase, and should progressively decrease.  **Remove when empty**
# * Debugging patches.
#       Temporary debugging patches, which must contain a CA reference.  Before
#       closing a ticket, you are expected to remove debugging patches.

revert-xen-3.4-18560.782599274bf9-ported.patch # This needs to be removed in a migrate-safe way

################################################################################
# XenServer build system integration
#
modify-xen-version.patch # Deliberately to conflict if upstream retags
chroot-build-tweaks.patch # Tweaks to make chroot builds similar to build system builds
builder-makefiles.patch # XS Makefile and Spec file
configure-build.patch # Configuration files for the build, including cached ./configure

build-disable-toplevel.patch # HACK
build-prune-system-integration.patch # HACK
build-prune-installed-binaries.patch # HACK
build-prune-python.patch # HACK
build-tweak-banner.patch # HACK - prevent -xs$BUILDNUM sneaking into the Xen figlet banner
build-docs-install-manpages.patch # Kudge - should find better solution upstream
build-xenstore-client-install.patch # Why on earth does the installer need xenstore?
xs.h-warnings.patch # Remove #warning's from xs.h until we fix up components in the build system

################################################################################
# Upstream patches
#
# Naming scheme as "xen-<version>.hg-<rev>.<hash>[-ported].patch"
#     <version>   typically unstable
#     <rev>       patch revision
#     <hash>      patch short hash
#     [-ported]   indicates that the patch has had to be ported to apply
#

# Patches from xen-4.3-testing.hg

# Patches from xen-unstable.hg
xen-unstable.hg-27238.6542a6b34d7b.patch # xl: Add 'xen_version' to `xl info`
xen-unstable.hg-27332.506035822685.patch # rombios/keyboard: Don't needlessly poll the status register
xen-unstable.hg-27333.7ff8434f9fcb.patch # rombios/ata: Do not wait for BSY to be set
xen-unstable.hg-27334.5dae5d46ab1d.patch # rombios/ata: Reading this status register has no relevant side effects
xen-unstable.hg-27335.36efd0b3e55f.patch # rombios/ata Remove another needless trap from the int 0x13 hotpath
xen-unstable.hg-27336.d3ea90d704e3.patch # rombios/debug: Reduce verbosity of rombios
xen-unstable.hg-27431.1f636f9a3349.patch # x86: don't allow Dom0 access to the HT address range
xen-unstable.hg-27434.f353e27a1f99.patch # x86/apic: remove Summit support
xen-unstable.hg-27435.c84c66d50d14.patch # x86/time: remove Cyclone as a platform timer
# xen-unstable.hg-27436.93d4ee2987b5.patch # x86/boot: Explicitly clean pcpu stacks in debug builds
xen-unstable.hg-27635.45bf542dd584.patch # x86/crash: Indicate how well nmi_shootdown_cpus() managed to do

################################################################################
# Patches which are upstream but hard to backport
#

################################################################################
# Patches for upstream
#
assert-printk.patch # andrewcoop
parallel-bootscrub.patch # malcolmc
add-ivy-bridge-EP-EN-EX-cpu-to-cpuid-masking.patch # malcolmc
detect-nehalem-c-state.patch # malcolmc
add-clflush-before-monitor-intel-7400-series.patch # malcolmc

sysctl-conring-size.patch # andrewcoop
libxc-consoleringsize.patch # andrewcoop
libxc-readconsolering-hypercallbuffer.patch # andrewcoop
ocaml-xc-stubs-fix-readconsolering.patch # andrewcoop
ocaml-xc-stubs-fix-failwith_xc.patch # andrewcoop

# dvrabel kexec-v6
0001-x86-give-FIX_EFI_MPF-its-own-fixmap-entry.patch
0002-xen-make-GUEST_HANDLE_64-and-uint64_aligned_t-availa.patch
0003-kexec-add-public-interface-for-improved-load-unload-.patch
0004-kexec-add-infrastructure-for-handling-kexec-images.patch
0005-kexec-extend-hypercall-with-improved-load-unload-ops.patch
0006-xen-kexec-crash-image-when-dom0-crashes.patch
0007-libxc-add-hypercall-buffer-arrays.patch
0008-libxc-add-API-for-kexec-hypercall.patch
0009-x86-check-kexec-relocation-code-fits-in-a-page.patch

# dvrabel - v1 posted
0001-trace-include-timestamp-in-trace-records-added-by-HV.patch
0002-trace-allow-HVMOP_xentrace-to-set-trace-record-subcl.patch
0003-libxc-add-xc_tbuf_trace-to-insert-trace-records.patch

# robho - libxl/ocaml patches (mostly posted to xen-devel)
0001-libxl-Add-LIBXL_SHUTDOWN_REASON_UNKNOWN.patch
0002-libxl-idl-allow-KeyedUnion-members-to-be-empty.patch
0003-libxl-idl-add-domain_type-field-to-libxl_dominfo-str.patch
0004-libxl-idl-complete-some-enums-in-the-IDL-with-their-.patch
0005-libxl-ocaml-fix-code-intended-to-output-comments-bef.patch
0006-libxl-ocaml-support-for-Arrays-in-bindings-generator.patch
0007-libxl-ocaml-avoid-reserved-words-in-type-and-field-n.patch
0008-libxl-ocaml-support-for-KeyedUnion-in-the-bindings-g.patch
0009-libxl-ocaml-add-some-more-builtin-types.patch
0010-libxc-ocaml-add-simple-binding-for-xentoollog-output.patch
0011-libxl-ocaml-allocate-a-long-lived-libxl-context.patch
0012-libxl-ocaml-switch-all-functions-over-to-take-a-cont.patch
0013-libxl-ocaml-propagate-the-libxl-return-error-code-in.patch
0014-libxl-ocaml-make-Val_defbool-GC-proof.patch
0015-libxl-ocaml-add-domain_build-create_info-config-and-.patch
0016-libxl-ocaml-add-META-to-list-of-generated-files-in-M.patch
0017-libxl-ocaml-fix-the-handling-of-enums-in-the-binding.patch
0018-libxl-ocaml-use-the-string-option-type-for-IDL-strin.patch
0019-libxl-ocaml-add-xen_console_read.patch
0020-libxl-ocaml-add-dominfo_list-and-dominfo_get.patch
0021-libxl-ocaml-implement-some-simple-tests.patch
0022-libxl-ocaml-event-management.patch
0023-libxl-ocaml-allow-device-operations-to-be-called-asy.patch
0024-libxl-ocaml-add-NIC-helper-functions.patch
0025-libxl-ocaml-add-PCI-device-helper-functions.patch
0026-libxl-ocaml-add-disk-and-cdrom-helper-functions.patch
0027-libxl-ocaml-add-VM-lifecycle-operations.patch
0028-libxl-ocaml-in-send_debug_keys-clean-up-before-raisi.patch
0029-libxl-ocaml-provide-defaults-for-libxl-types.patch
0030-libxl-ocaml-use-CAMLlocal1-macro-rather-than-value-t.patch
0031-libxl-ocaml-use-string-for-uuid.patch
0032-libxl-define-OCAML_READY.patch
0033-libxl-an-unknown-shutdown-reason-may-manifest-as-255.patch
0034-libxl-ocaml-fix-bitmap-alloc-in-xenlight-bindings.patch
0035-libxl-ocaml-makefile.patch

CA-100569-xenstore-quota-leak # jeromem (or other ring3)

fix-xen-ringwatch-path-for-pvops-kernel.patch # malcolmc

0001-x86-idle-Fix-get_cpu_idle_time-s-interaction-with-of.patch # andrewcoop
0002-x86-percpu-Force-INVALID_PERCPU_AREA-into-the-non-ca.patch # andrewcoop

################################################################################
# Un-upstreamable patches
#
xen-tweak-cmdline-defaults.patch
cc-restrictions.patch
cc-decrease-reservation.patch
tweak-iommu-errata-policy.patch

# Un-upstreamable hacks to make the legacy windows PV drivers work on modern Xen
xen-legacy-win-driver-version.patch
xen-legacy-win-xenmapspace-quirks.patch
xen-legacy-32bit_shinfo.patch
xen-legacy-process-dying.patch

################################################################################
# Technical debt
#

# xen debt
xen-dont-hide-vtx-or-svm.patch # for xenrt.  Very unsafe :(
xen-define-offsets-for-kdump.patch
xen-scheduler-auto-privdom-weight.patch
xen-memcpy-nt.patch # non-temporal memcpy, for gntcpy
xen-lowmem-emergency-pool.patch # argument appears wrong ?
xen-dont-emulate-movnti.patch
xen-hvm-disable-tsc-ramping.patch
xen-hvm-hpet-extra-50us.patch
xen-npt-detect-barcelona.patch
xen-hvm-hide-nx.patch
xen-viridian-extra-hypercalls.patch
xen-hvm-disable-console-params.patch
xen-quieten-cpuid-masking-error.patch # Only needed because Xapi doesn't understand cpuid_mask_xsave_eax
xen-stack-pointer-position.patch
xen-capture-boot-cpuid-info.patch
xen-apply-cpuid-mask-to-cpuid-faulting.patch
xen-hvm-bufioreq-eventchannel.patch
xen-hvm-triple-fault-means-crash.patch
xen-disable-xsave.patch # default xsave to off (like 4.1).  Needs CP-4312 to fix Ubuntu 12.04 properly
xen-hide-fma4-on-amd-fam15h.patch # disable FMA4 if xsave is disabled.  For Ubuntu 12.04 on AMD
xen-reduce-debug-tlbflush-cost.patch # Dont deliberatly wrap the TLB generation in debug builds
disable-oprofile-callgraph.patch # Currently oprofile callgraph seems to return invalid samples

# libxc debt
libxc-uclibc-threading.patch # for uclibc - do we need this any more?
libxc-uclibc-fadvise.patch # for uclibc - no posix_fadvise
libxc-native-protocol-accessor.patch # for xapi - apparently needed until based on libxl
libxc-ioctl-restrict.patch # for privelege restriction
libxc-stubs-hvm_check_pvdriver.patch
libxc-ext-6.patch
libxc-ext-7.patch
libxc-ext-8.patch
libxc-revert-qemu-tail.patch
libxc-domain-resume-one-checkpoint.patch
libxc-use-default-cpuid-policies.patch
libxc-empty-pipe.patch
libxc-pagebuf_get_one_error.patch

# libxl debt
libxl-default-config.patch # This is kudgy - merge into system configuration ?

# pygrub debt
pygrub-add-default-and-extra-args.patch
pygrub-always-boot-default.patch
pygrub-friendly-no-fs.patch
pygrub-blacklist-oel5.6.patch

# BIOS debt
oem-bios-xensource.patch # Can probably all be discarded
oem-bios-magic-from-xenstore.patch # Need to tweak, but should be upstreamed
hvmloader-booleans-from-xenstore.patch # Hack for boolean values from xenstore

# misc debt
misc-xeninfo-tool.patch # Superseeded by `xl info`
misc-crash-guest.patch # Superseeded by `xen-hvmcrash`
misc-log-guest-consoles.patch # xenconsoled listening to xenstore.  Do we use this?
fix-ocaml-libs.patch

# mixed between components
mixed-domain-runstates.patch
mixed-xc-sockets-per-core.patch
mixed-cpuid-before-mask.patch
xenguest.patch

#xenstore-xenbus-only-commu.patch
oxenstore-customize.patch
oxenstore-update.patch

# Power debt
power-old.patch

################################################################################
# Debugging patches
#
ca-107844-debug.patch # Pending EOI stack priority violation
msi-dump.patch # Make __dump_msi()s easier to use during a crash
ca-113568-debug.patch # HPET stack overflow
