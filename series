#
# XenServer patch queue on top of xen-4.4-testing.hg
#    Upstream at http://xenbits.xen.org/hg/xen-4.4-testing.hg/
#
# In an effort to reduce future work of upgrading Xen versions, all patches in
# this queue require a justification as to why they can't/won't be upstreamed,
# with the implication that everything else should be upstreamed.
#
# If in any doubt, the ring0 patch queue maintainer will be happy to help.
#
# All patches should follow the guidelines listed here:
#       http://wiki.xen.org/wiki/Submitting_Xen_Patches
# in particular with respect to a description and S-o-b lines, with the
# exception of temporary debugging patches, which should contain at least a CA
# reference.
#
# Overview of sections:
# * XenServer build system integration.
#       **Minimal Upstream makefile hacks**
# * Upstream patches.
#       Verbatim patches from upstream, possibly with tweaks because of backporting
#       Typically from xen-{4.3,unstable}.hg
# * Patches which are upstream but hard to backport.
#       Only if upstream has diverged enough.  Hopefully empty
# * Patches for upstream.
#       Most patches should be in this section, especially new ones.  By using
#       this section, you are assuming responsibility for getting the patches
#       included upstream, and will be periodically chased by the patch queue
#       maintainer.
# * Un-upstreamable patches.
#       CC-mode restrictions etc.  Should be minimal.
# * Technical debt.
#       Legacy patches brought forward from the past.  This section should
#       never increase, and should progressively decrease.  **Remove when empty**
# * Debugging patches.
#       Temporary debugging patches, which must contain a CA reference.  Before
#       closing a ticket, you are expected to remove debugging patches.

revert-xen-3.4-18560.782599274bf9-ported.patch # This needs to be removed in a migrate-safe way

# To avoid needing specfile hacks
xen-unstable.hg-28503.86b84e26a03e.patch # tools/xen-mceinj: Fix depency for the install rule

################################################################################
# XenServer build system integration
#
modify-xen-version.patch # Deliberately to conflict if upstream retags
chroot-build-tweaks.patch # Tweaks to make chroot builds similar to build system builds

build-disable-qemu-trad.patch # Disable the qemu trad build while still letting the tools think it exists
build-disable-toplevel.patch # HACK
build-prune-system-integration.patch # HACK
build-prune-installed-binaries.patch # HACK
build-prune-python.patch # HACK

build-tweak-banner.patch # prevent -xs$BUILDNUM sneaking into the Xen figlet banner
build-docs-install-manpages.patch # Kudge - should find better solution upstream
build-xenstore-client-install.patch # Why on earth does the installer need xenstore?

configure-build.patch # Configuration files for the build, including cached ./configure
builder-makefiles.patch # XS Makefile and Spec file

################################################################################
# Upstream patches
#
# Naming scheme as "xen-<version>.hg-<rev>.<hash>[-ported].patch"
#     <version>   typically unstable
#     <rev>       patch revision
#     <hash>      patch short hash
#     [-ported]   indicates that the patch has had to be ported to apply
#

# Patches from xen-4.4-testing.hg

# Patches from xen-unstable.hg
xen-unstable.hg-28408.2a5e24220408.patch # x86/hvm/rtc: don't run the vpt timer when !REG_B.PIE
xen-unstable.hg-28409.d320a1047a93.patch # x86/hvm/rtc: inject RTC periodic interupts from the vpt code
xen-unstable.hg-28410.04bd11d978be.patch # x86/hvm/rtc: always deassert the IRQ line when clearing REG_C.IRQF
xen-unstable.hg-28418.0367c90f4954.patch # x86/cpu: Store extended cpuid level in cpuinfo_x86
xen-unstable.hg-28419.87fe64d55607.patch # x86/faulting: Use formal defines instead of opencoded bits
xen-unstable.hg-28420.ff8fb9bf64b7.patch # ns16550: Add support for UART present in Broadcom TruManage capable NetXtreme chips
xen-unstable.hg-28424.985533a01e0e.patch # vsprintf: introduce %pv extended format specifier to print domain/vcpu ID pair
xen-unstable.hg-28425.d947bfff4973.patch # flask: add compat mode guest support
xen-unstable.hg-28426.a323f7817894.patch # flask: use xzalloc()
xen-unstable.hg-28427.82fac3252fd0.patch # xsm: use # printk format modifier
xen-unstable.hg-28428.166cd863447b.patch # xsm: streamline xsm_default_action()
xen-unstable.hg-28429.8a85db8512ca.patch # mm: ensure useful progress in decrease_reservation
xen-unstable.hg-28431.4f505f08f7c8.patch # x86/time: cleanup
xen-unstable.hg-28437.8cd76f80517b.patch # include: parallelize compat/xlat.h generation
xen-unstable.hg-28438.c5c99c73d198.patch # x86/crash: fix up declaration of do_nmi_crash()
xen-unstable.hg-28439.e7f183d57195.patch # compiler: replace opencoded __attribute__((noreturn))
xen-unstable.hg-28440.2366588d97c2.patch # identify panic and reboot/halt functions as noreturn
xen-unstable.hg-28441.1e22597f6d0c.patch # misc cleanup as a result of the previous patches
xen-unstable.hg-28442.6a9653816adb.patch # x86: identify reset_stack_and_jump() as noreturn
xen-unstable.hg-28460.a0948bff46e3.patch # x86/schedule: remove noreturn from schedule_tail() function pointer
xen-unstable.hg-28461.42ddb85d20cf.patch # x86/time: always count s_time from Xen boot
xen-unstable.hg-28471.feb5d135a95a.patch # tools/xcutils: Free xtl loggers after use
xen-unstable.hg-28489.9100f8275102.patch # xen/pygrub: grub2/grub.cfg from RHEL 7 has new commands in menuentry
xen-unstable.hg-28493.e8c62e5e942c.patch # libxl: Fix error path in libxl_device_events_handler
xen-unstable.hg-28496.b4593c67eace.patch # tools/libxl: Don't read off the end of tinfo[]
xen-unstable.hg-28507.471ad07cf29d.patch # common: make hypercall preemption checks consistent
xen-unstable.hg-28508.d240dab2fe5b.patch # x86: make hypercall preemption checks consistent
xen-unstable.hg-28509.40b60c5823ea.patch # time: move wallclock_time() declaration into common code
xen-unstable.hg-28510.4cd93b5a7441.patch # x86/time: initialise time earlier during start_secondary()
xen-unstable.hg-28511.1607344f3cae.patch # console: provide timestamps as an offset since boot
xen-unstable.hg-28512.31507e846448.patch # console: Traditional console timestamps including milliseconds
xen-unstable.hg-28513.b554f3ebb754.patch # libxl: Hold the atfork lock while closing carefd
xen-unstable.hg-28541.77e698a554c3-ported.patch # VT-d: fix RMRR handling
xen-unstable.hg-28542.63c7ca307330.patch # x86/Intel: work around Xeon 7400 series erratum AAI65
xen-unstable.hg-28566.99519d6a348d.patch # x86: Intel CPU family update
xen-unstable.hg-28567.9f16ea3e64ce.patch # x86/idle: update to include further package/core residency MSRs
xen-unstable.hg-28626.da3dfb6b0155.patch # x86: identify which vcpu's CR4 is being badly modified

################################################################################
# Patches which are upstream but hard to backport
#

################################################################################
# Patches for upstream
#
parallel-bootscrub.patch # malcolmc
detect-nehalem-c-state.patch # malcolmc

sysctl-conring-size.patch # andrewcoop
libxc-consoleringsize.patch # andrewcoop
libxc-readconsolering-hypercallbuffer.patch # andrewcoop
ocaml-xc-stubs-fix-readconsolering.patch # andrewcoop
ocaml-xc-stubs-fix-failwith_xc.patch # andrewcoop

# dvrabel - v1 posted
0001-trace-include-timestamp-in-trace-records-added-by-HV.patch
0002-trace-allow-HVMOP_xentrace-to-set-trace-record-subcl.patch
0003-libxc-add-xc_tbuf_trace-to-insert-trace-records.patch

# jeromem (or other ring3)
CA-100569-xenstore-quota-leak.patch

fix-xen-ringwatch-path-for-pvops-kernel.patch # malcolmc

# Generation ID (andrewcoop)
vmgenid-restore.patch

ocaml-gntshr-gnttab.patch # johnel
local-ocaml-gnt-installables.patch

0001-Control-ACPI-debugging-using-a-platform-flag.patch

# v3 of pygrub patch posted (jobyp)

# Hpet improvements v5
0001-x86-hpet-Pre-cleanup.patch
0002-x86-hpet-Use-singe-apic-vector-rather-than-irq_descs.patch
0003-x86-hpet-Post-cleanup.patch

# Migration v2
0001-tools-libxc-save-restore-v2.patch
0002-Stream-specification-and-some-common-code.patch
0003-Scripts-for-inspection-valdiation-of-legacy-and-new-.patch
0004-x86-common.patch
0005-x86_pv-save.patch
0006-x86_pv-restore.patch
car1485-cp8088-ballooning.patch
car1485-fixes.patch

################################################################################
# Un-upstreamable patches
#
xen-tweak-cmdline-defaults.patch
cc-restrictions.patch
cc-decrease-reservation.patch
tweak-iommu-errata-policy.patch
libxc-restore-legacy-image.patch

# Un-upstreamable hacks to make the legacy windows PV drivers work on modern Xen
xen-legacy-win-driver-version.patch
xen-legacy-win-xenmapspace-quirks.patch
xen-legacy-32bit_shinfo.patch
xen-legacy-process-dying.patch
xen-legacy-late-bufioreq-eventchannel.patch

################################################################################
# Technical debt
#

# xen debt
xen-dont-hide-vtx-or-svm.patch # for xenrt.  Very unsafe :(
xen-define-offsets-for-kdump.patch
xen-scheduler-auto-privdom-weight.patch
xen-memcpy-nt.patch # non-temporal memcpy, for gntcpy
xen-hvm-disable-tsc-ramping.patch
xen-npt-detect-barcelona.patch
xen-hvm-hide-nx.patch
xen-viridian-extra-hypercalls.patch
xen-hvm-disable-console-params.patch
xen-quieten-cpuid-masking-error.patch # Only needed because Xapi doesn't understand cpuid_mask_xsave_eax
xen-capture-boot-cpuid-info.patch
xen-apply-cpuid-mask-to-cpuid-faulting.patch
xen-hvm-triple-fault-means-crash.patch
xen-disable-xsave.patch # default xsave to off (like 4.1).  Needs CP-4312 to fix Ubuntu 12.04 properly
xen-hide-fma4-on-amd-fam15h.patch # disable FMA4 if xsave is disabled.  For Ubuntu 12.04 on AMD
xen-reduce-debug-tlbflush-cost.patch # Dont deliberatly wrap the TLB generation in debug builds
disable-oprofile-callgraph.patch # Currently oprofile callgraph seems to return invalid samples
xen-properly-disable-hpet.patch # If the HVM param disabled HPETs, then disable them fully rather than passing to qemu

# libxc debt
libxc-native-protocol-accessor.patch # for xapi - apparently needed until based on libxl
libxc-stubs-hvm_check_pvdriver.patch
libxc-ext-6.patch
libxc-ext-7.patch
libxc-ext-8.patch
libxc-use-default-cpuid-policies.patch
libxc-empty-pipe.patch
libxc-reduce-mapping-logging.patch # CA-111022

# libxl debt
libxl-tap-device-name.patch
xl-info-specific.patch # End result considered acceptable upstream.  Implementation might need redoing in 4.5 dev window.

# pygrub debt
pygrub-add-default-and-extra-args.patch
pygrub-always-boot-default.patch
pygrub-friendly-no-fs.patch

# BIOS debt
oem-bios-xensource.patch # Can probably all be discarded
oem-bios-magic-from-xenstore.patch # Need to tweak, but should be upstreamed

# misc debt
misc-log-guest-consoles.patch # xenconsoled listening to xenstore.  Do we use this?
fix-ocaml-libs.patch

# mixed between components
mixed-domain-runstates.patch
mixed-xc-sockets-per-core.patch
mixed-cpuid-before-mask.patch
xenguest.patch

#xenstore-xenbus-only-commu.patch
oxenstore-customize.patch
oxenstore-update.patch

# Experimental patches for hwloc support (andrewcoop)
libxc-topology-numa-info-bounced.patch
xen-libxc-cpuid-sysctl.patch

################################################################################
# Debugging patches
#
ca-107844-debug.patch # Pending EOI stack priority violation
ca-121760-debug-late-shootdown.patch
ca-126041-identify-bad-msr-access.patch
